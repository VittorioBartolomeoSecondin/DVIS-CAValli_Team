<!DOCTYPE html>
<html lang="en">
    <head>
        <link rel="stylesheet" type="text/css" href="styles.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
        <meta charset="utf-8">
        <title>Project</title>
        <link rel="icon" type="image/x-icon" href="favicon.ico">
        
    </head>
    
    <body>
        
        <div style="display: flex; justify-content: space-between;">
            <h1 style="flex: 1;">
                Section 2: ...
            </h1>
            <a href="https://vittoriobartolomeosecondin.github.io/DVIS-CAValli_Team/index.html" class="btn btn-primary btn-lg" style="font-size: 25px; padding: 10px 20px;">Back</a>
        </div>
        
        <hr>
        <script src="https://d3js.org/d3.v7.js"></script>
        <script src="https://unpkg.com/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
        <script src="scripts/section2/sankey.js"></script>
        <script>
            // set the dimensions and margins of the graph
            var margin = {top: 20, right: 40, bottom: 70, left: 240},
                width = 1000 - margin.left - margin.right,
                height = 600 - margin.top - margin.bottom;  
            
            // format variables
            var formatNumber = d3.format(",.0f"), // zero decimal places
                format = function(d) { return formatNumber(d); },
                color = d3.scaleOrdinal(d3.schemeCategory10);
              
            // append the svg object to the body of the page
            var svg = d3.select("body").append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
              .append("g")
                .attr("transform", 
                      "translate(" + margin.left + "," + margin.top + ")");
            
            // Set the sankey diagram properties
            var sankey = d3.sankey()
                .nodeWidth(36)
                .nodePadding(40)
                .size([width, height]);
            
            var path = sankey.links();

            // load the data
            d3.csv("data/section2/sankey.csv").then(function(data) {

                // set up graph
                graph = { "nodes": [], "links": [] };
            
                data.forEach(function(d) {
                    // Check if the source node already exists
                    let sourceNode = graph.nodes.find(node => node.name === d.source);
                    if (!sourceNode) {
                        sourceNode = { "name": d.source };
                        graph.nodes.push(sourceNode);
                    }

                    // Check if the target node already exists
                    let targetNode = graph.nodes.find(node => node.name === d.target);
                    if (!targetNode) {
                        targetNode = { "name": d.target };
                        graph.nodes.push(targetNode);
                    }

                    // Push the link using the found or created nodes
                    graph.links.push({
                        "source": d.source,
                        "target": d.target,
                        "value": +d.value
                    });
                });
                
                /*
                //set up graph
                graph = {"nodes" : [], "links" : []};
            
                data.forEach(function (d) {
                    graph.nodes.push({ "name": d.source });
                    graph.nodes.push({ "name": d.target });
                    graph.links.push({ "source": d.source,
                                       "target": d.target,
                                       "value": +d.value });
                });       
                
                // return only the distinct / unique nodes
                 graph.nodes = d3.keys(d3.nest()
                   .key(function (d) { return d.name; })
                   .object(graph.nodes));
                
                
                // loop through each link replacing the text with its index from node
                 graph.links.forEach(function (d, i) {
                 graph.links[i].source = graph.nodes.indexOf(graph.links[i].source);
                 graph.links[i].target = graph.nodes.indexOf(graph.links[i].target);
                });
                */
                
                console.log(graph);
                
                for (let i = 1; i < graph.links.length; i++) {
                  graph.links[i].source = graph.nodes.indexOf(graph.links[i].source);
                  graph.links[i].target = graph.nodes.indexOf(graph.links[i].target);
                }
            
                // now loop through each nodes to make nodes an array of objects
                // rather than an array of strings
                graph.nodes.forEach(function (d, i) {
                  graph.nodes[i] = { "name": d };
                });
            
                sankey
                    .nodes(graph.nodes)
                    .links(graph.links)
                    .layout(32);
                
                // add in the links
                var link = svg.append("g").selectAll(".link")
                    .data(graph.links)
                .enter().append("path")
                    .attr("class", "link")
                    .attr("d", d3.sankeyLinkHorizontal())
                    .attr("stroke-width", function(d) { return d.width; });  
                
                // add the link titles
                link.append("title")
                    .text(function(d) {
                            return d.source.name + " â†’ " + 
                            d.target.name + "\n" + format(d.value); });
                
                // add in the nodes
                var node = svg.append("g").selectAll(".node")
                    .data(graph.nodes)
                .enter().append("g")
                    .attr("class", "node");
                
                // add the rectangles for the nodes
                node.append("rect")
                    .attr("x", function(d) { return d.x0; })
                    .attr("y", function(d) { return d.y0; })
                    .attr("height", function(d) { return d.y1 - d.y0; })
                    .attr("width", sankey.nodeWidth())
                    .style("fill", function(d) { 
                        return d.color = color(d.name.replace(/ .*/, "")); })
                    .style("stroke", function(d) { 
                        return d3.rgb(d.color).darker(2); })
                    .append("title")
                      .text(function(d) { 
                          return d.name + "\n" + format(d.value); });
                
                // add in the title for the nodes
                node.append("text")
                    .attr("x", function(d) { return d.x0 - 6; })
                    .attr("y", function(d) { return (d.y1 + d.y0) / 2; })
                    .attr("dy", "0.35em")
                    .attr("text-anchor", "end")
                    .text(function(d) { return d.name; })
                .filter(function(d) { return d.x0 < width / 2; })
                    .attr("x", function(d) { return d.x1 + 6; })
                    .attr("text-anchor", "start");
                
            });
        </script> 

        <hr>
        
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.min.js" integrity="sha384-cuYeSxntonz0PPNlHhBs68uyIAVpIIOZZ5JqeqvYYIcEL727kskC66kF92t6Xl2V" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
        <script src="https://code.jquery.com/jquery-3.7.1.slim.js" integrity="sha256-UgvvN8vBkgO0luPSUl2s8TIlOSYRoGFAX4jlCIm9Adc=" crossorigin="anonymous"></script>
    </body>
</html>
